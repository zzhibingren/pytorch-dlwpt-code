https://zhuanlan.zhihu.com/p/458044342


用价格矩阵来构造收益率矩阵，直接用DataFrame的pct_change函数就可以了。

day_return=pricedf.pct_change().shift(-1)




如何理解：

df.pct_change()

df = pd.DataFrame({
   'FR': [4.0405, 4.0963, 4.3149],
    'GR': [1.7246, 1.7482, 1.8519],
     'IT': [804.74, 810.01, 860.13]},
     index=['1980-01-01', '1980-02-01', '1980-03-01'])
print(df)
print(df.pct_change())
print(df.pct_change(axis='columns'))#可以指定按照行还是列进行计算的

默认是按照‘行’向上参照。

结果如下：

                FR      GR      IT
1980-01-01  4.0405  1.7246  804.74
1980-02-01  4.0963  1.7482  810.01
1980-03-01  4.3149  1.8519  860.13
                  FR        GR        IT
1980-01-01       NaN       NaN       NaN
1980-02-01  0.013810  0.013684  0.006549
1980-03-01  0.053365  0.059318  0.061876

            FR        GR          IT
1980-01-01 NaN -0.573172  465.624145
1980-02-01 NaN -0.573225  462.339435
1980-03-01 NaN -0.570813  463.458124

原文链接：https://blog.csdn.net/weixin_43213268/article/details/89053240


然后 shift(-1) -> 行向上移动一行，日期描述保持不变。


这里要注意，我算完之后用shift(-1)往前移了一天，
这样算出来的2021年5月20日的收益率实际上对应的是20日收盘到21日收盘之间的收益率，
这是因为我们在后面的计算中算出的策略信号矩阵是用20日的数据求得20日盘尾的信号，
我们如果在20日盘尾按此信号买入的话那么实现的收益率正好对应后一天的收益率，
这样我们在后面计算的时候就实现了日期对齐了。

（jimmy: 意思是指实际的操作策略， 如果没有手续费的情况， 第一天收盘时买入， 第二天收盘时卖出.)
不考虑存在手续费， 国内可转债 convertible bond 买卖没有手续费。而且可以T+0 .


考虑扩展， 一个票拿在手上 ，持续7天， 那么他的持有模型矩阵就不再是

factor=premdf+pricedf


N=5 
def selectTopN(tmp):    
	tmp=tmp.copy()    
	symbols=tmp.nsmallest(N).index    
	tmp[:]=0    
	tmp[symbols]=1    
	return tmp
signal=factor.apply(selectTopN,axis=1)

signal是当前的topN个 双低因子的 持有矩阵 (代表现在每天收盘时买入 (按当天的双低决策选出N只可转债）， 第二天收盘时卖出的策略)
 

当之最短只持有一天， 并且每天收盘都是按照双低因子来做一次新的决策的话， 
持有矩阵（signal) is more like： (change every day)
 
 top2 .
             FR      GR      IT   GC 
1980-01-01  1  	      0      0    1
1980-02-01  0         1      1    0
1980-03-01  1         0      0    1




 持有矩阵（signal) 更像：
 
 
             FR      GR      IT   GC 
1980-01-01  1  	      0       0   1  (keep for somedays)
1980-02-01  1         0       0   1
1980-03-01  .....
1980-03-07  1         1       0   0
1980-03-08  1         1       0   0
1980-03-09  .....                    (keep for somedays again.)




day_return=pricedf.pct_change().shift(-1)

day return matrix:

bond_id       110033    110034    110038    110041    110042    110043  \
date                                                                     
2020-05-06 -0.001168 -0.000166 -0.007465 -0.006441 -0.002074 -0.002024   
2020-05-07  0.000180  0.000497  0.000612 -0.001314  0.002660  0.001751   
2020-05-08 -0.000989  0.001573  0.014421 -0.002105 -0.000415  0.000552   
2020-05-11 -0.005220 -0.001323 -0.008185 -0.007648 -0.001742 -0.004874   
2020-05-12 -0.002533 -0.002483 -0.004778  0.004518 -0.001329 -0.001386   
...              ...       ...       ...       ...       ...       ...   
2023-05-30  0.000000  0.000000  0.000000  0.000000  0.000000 -0.002726   
2023-05-31  0.000000  0.000000  0.000000  0.000000  0.000000 -0.002599  


pricedf:

bond_id     110033  110034  110038  110041  110042   110043   110044   110045  \
date                                                                            
2020-05-06  111.34  120.73  115.21  114.89  120.55  108.700  180.760  101.880   
2020-05-07  111.21  120.71  114.35  114.15  120.30  108.480  153.720  101.720   
2020-05-08  111.23  120.77  114.42  114.00  120.62  108.670  164.940  101.400   
2020-05-11  111.12  120.96  116.07  113.76  120.57  108.730  174.870  101.250   
2020-05-12  110.54  120.80  115.12  112.89  120.36  108.200  178.040  101.270   
...            ...     ...     ...     ...     ...      ...      ...      ...   
2023-05-30     NaN     NaN     NaN     NaN     NaN  111.875  193.528  124.001   
2023-05-31     NaN     NaN     NaN     NaN     NaN  111.570  193.720  124.104   
2023-06-01     NaN     NaN     NaN     NaN     NaN  111.280  210.244  125.370   


bondPremRatio matrix:
bond_id        110033     110034     110038     110041     110042     110043  \
date                                                                           
2020-05-06  30.925959  20.139794  31.707334  29.079602  22.537563  27.743898   
2020-05-07  30.566171  18.892860  29.928581  29.799597  21.413096  28.497143   
2020-05-08  29.361536  18.951957  28.981579  28.592000  21.996548  27.457741   
2020-05-11  30.254408  22.295099  22.054545  28.836627  21.945977  27.528114   
2020-05-12  30.191556  18.726180  24.730464  28.366855  22.256791  27.407101   
...               ...        ...        ...        ...        ...        ...   
bond_id         110044     110045     110047     110048  ...      128136  \
date                                                     ...               
2020-05-06   82.079416  95.622620  26.276412  28.214034  ...         NaN   
2020-05-07   57.602972  99.457488  25.532957  25.949392  ...         NaN   
2020-05-08   67.612077  97.541005  25.899136  26.098701  ...         NaN   
2020-05-11   79.287221  96.929612  24.920395  27.748179  ...         NaN   
2020-05-12   83.628700  96.650307  23.732313  28.498535  ...         NaN   
...
bond_id         110044     110045     110047     110048  ...      128136  \
date                                                     ...               
2020-05-06   82.079416  95.622620  26.276412  28.214034  ...         NaN   
2020-05-07   57.602972  99.457488  25.532957  25.949392  ...         NaN   
2020-05-08   67.612077  97.541005  25.899136  26.098701  ...         NaN   
2020-05-11   79.287221  96.929612  24.920395  27.748179  ...         NaN   
2020-05-12   83.628700  96.650307  23.732313  28.498535  ...         NaN   







factor matrix:
bond_id         110033      110034      110038      110041      110042  \
date                                                                     
2020-05-06  142.265959  140.869794  146.917334  143.969602  143.087563   
2020-05-07  141.776171  139.602860  144.278581  143.949597  141.713096   
2020-05-08  140.591536  139.721957  143.401579  142.592000  142.616548   
2020-05-11  141.374408  143.255099  138.124545  142.596627  142.515977   
2020-05-12  140.731556  139.526180  139.850464  141.256855  142.616791   
...                ...         ...         ...         ...         ...   
2023-05-30         NaN         NaN         NaN         NaN         NaN   
2023-05-31         NaN         NaN         NaN         NaN         NaN   
2023-06-01         NaN         NaN         NaN         NaN         NaN   
2023-06-02         NaN         NaN         NaN         NaN         NaN   
2023-06-05         NaN         NaN         NaN         NaN         NaN   

bond_id         110043      110044      110045      110047      110048  ...  \
date                                                                    ...   
2020-05-06  136.443898  262.839416  197.502620  140.076412  143.274034  ...   
2020-05-07  136.977143  211.322972  201.177488  138.662957  140.759392  ...   
2020-05-08  136.127741  232.552077  198.941005  139.359136  140.598701  ...   
2020-05-11  136.258114  254.157221  198.179612  138.620395  141.938179  ...   
2020-05-12  135.607101  261.668700  197.920307  137.462313  142.298535  ...   
...                ...         ...         ...         ...         ...  ...   
2023-05-30  126.394318  321.757572  140.676293  139.723892  201.299390  ...   
2023-05-31  125.985137  317.545135  139.381257  139.667703  202.438006  ...   
2023-06-01  126.446618  331.145530  140.351194  138.098268  208.158182  ...   
2023-06-02  127.487082  325.390064  142.645552  138.812406  208.151694  ...   
2023-06-05  126.196588  321.035981  141.196525  137.324446  209.110032  ...   

bond_id         128136      128137      128138  128139      128140  \
date                                                                 
2020-05-06         NaN         NaN         NaN     NaN         NaN   
2020-05-07         NaN         NaN         NaN     NaN         NaN   
2020-05-08         NaN         NaN         NaN     NaN         NaN   
2020-05-11         NaN         NaN         NaN     NaN         NaN   
2020-05-12         NaN         NaN         NaN     NaN         NaN   
...                ...         ...         ...     ...         ...   
2023-05-30  239.676130  165.509587  258.330889     NaN  206.760793   
2023-05-31  243.753729  168.102016  262.303745     NaN  207.674877   
2023-06-01  237.964912  166.791516  261.003861     NaN  209.267142  






#接下来终于到了激动人心的收益序列计算了，其实这步是最简单的，直接两个矩阵乘一下，注意这里并不是线性代数里面的矩阵乘法，而是两个矩阵的相同位置的数字直接相乘。然后将每行的结果求和除以20，就得到收益率序列了。
pnl=(signal*day_return).sum(axis=1)/N


#到这里，计算就已经完成了，我们还可以画个净值曲线来直观地看下回测结果，只要把每日的收益率加1后连乘就可以了。
(pnl+1).cumprod().plot(figsize=(10,5),grid=True)

plt.show()







matplotlab  出错的问题：
https://www.cnblogs.com/xu-qingfeng/p/9726212.html
重启 jupyter 解决



so every time, how to 增量数据更新：

run blocks:
1.  for table: stock_conv_bond_value_analysis  (1 bond id -> list of items with date for each row  .)
#增量抓取数据， 应为 index在第一次建立表时已经创建， 
#理论上unique的数据不会存在， 可以安全的update.
#sql = "ALTER TABLE stock_conv_bond_value_analysis ADD UNIQUE index_name (date, bond_id);"



	a 股上市可转债 387 支 (2024 09 )
	so 387*5 = 1935/60 = 30多分钟 处理增量时间 -假设每一次 bond_id的处理请求是5秒钟

2. for table: conv_bond_details   (1 bond id -> 1 line   )
#regenerate convertible bond (重新抓取 convertible bond 详情数据，)
#and create index

    只处理一条请求， 可删除表重建。很快。
	


	
3.run 
#begin analysis https://zhuanlan.zhihu.com/p/458044342
#begin create matrix of bond price https://mp.weixin.qq.com/s/ZGth6LLZZQYkpvY11W20Pw

4. run
#计算因子准备
	


5. 最优策略：
#jimmy 2024 use good.

通常情况下，转股溢价率越低越好，因为转股溢价率较低时，意味着投资者在转股时可以用到更划算、甚至比市场价更低的价格买到股票，从而获得更大利润；

纯债溢价率越低，可转债的“债性”越强，对投资者来说也越安全。若溢价率过高，虽然说明投资者普遍对后期市场行情看好，但太高的溢价率可能透支了未来涨幅，因此在申购前溢价率适中即可，但最好还是负数比较合适，因为这意味着我们可以低价入手，也就是越便宜越好。不过，在可转债上市之后，我们作为卖方，当然就是希望价格越高越好，这时溢价率也就是越高越好了。12


prempurebond=filterdf.set_index(['date','bond_id']).unstack()['纯债溢价率']
premdf=filterdf.set_index(['date','bond_id']).unstack()['转股溢价率']


持有5支，排除暴雷的前6支。
factor=premdf*0.5+pricedf*0.4+prempurebond*0.1

每隔35天 ， 计算要持有的本期可转债股票列表。
               计算要持有的上期可转债股票列表。



latest selected bonds
bond_id
118026    1.0
123049    1.0
123099    1.0
123156    1.0
127049    1.0


4 年 2.4倍


pip install akshare==1.10.5






6 . 热度股票 分析， 小盘 。按 研报，和机构推荐 排序。
tag:

#puting together:

#新增热门股票 ， 市值小于100 亿，被 机构推荐和研报数据 存在。


#top hot stock number to select from:
TOP_HOT_NUMBER_TO_SEL=500


final list:
stock id:300662
       名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
186  科锐国际  300662   25             14.0    39.0
stock id:300785
      名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
918  值得买  300785   10              6.0    16.0
stock id:002803
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1292  吉宏股份  002803    7              6.0    13.0
stock id:603890
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1316  春秋电子  603890    7              6.0    13.0
stock id:300622
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1319  博士眼镜  300622    7              7.0    14.0
stock id:002659
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1412  凯文教育  002659    6              4.0    10.0
stock id:002582
       名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1750  好想你  002582    4              3.0     7.0
stock id:301160
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1821  翔楼新材  301160    4              3.0     7.0
stock id:300616
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
1832  尚品宅配  300616    4              2.0     6.0
stock id:300790
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2028  宇瞳光学  300790    3              2.0     5.0
stock id:301221
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2100  光庭信息  301221    2              2.0     4.0
stock id:002291
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2121  遥望科技  002291    2              0.0     2.0
stock id:605398
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2453  新炬网络  605398    1              1.0     2.0
stock id:301499
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2496  维科精密  301499    1              0.0     1.0
2786  维科精密  301499    1              0.0     1.0
stock id:000759
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2637  中百集团  000759    1              0.0     1.0
stock id:002189
       名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2674  中光学  002189    1              1.0     2.0
stock id:301499
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2496  维科精密  301499    1              0.0     1.0
2786  维科精密  301499    1              0.0     1.0
stock id:600581
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2855  八一钢铁  600581    1              1.0     2.0
stock id:002722
        名称      代码  研报数  机构投资评级(近六个月)-买入  sortby
2884  物产金轮  002722    1              0.0     1.0

			   

						   